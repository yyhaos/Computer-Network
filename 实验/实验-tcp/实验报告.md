## LAB-TCP

#### PREPARE

下载wget安装帧 [](https://jaist.dl.sourceforge.net/project/gnuwin32/wget/1.11.4-1/wget-1.11.4-1-setup.exe)  

并且设置好相应的系统变量。

#### Step 1: Capture a Trace

##### 1 选用网页: www.hdu.edu.cn/asset/home/images/logo.png hdu的logo图片

用命令：wget www.hdu.edu.cn/asset/home/images/logo.png

![](res/cap1.png)

捕获得到200 OK。

##### 2 关闭无关程序

##### 3 启动wire shark 并且设置filter：tcp and host www.hdu.edu.cn 
![](res/cap2.png)
电脑用的是wlan连接网络。

##### 4 捕获
在启动wire shark捕获后，再次运行命令

`wget www.hdu.edu.cn/asset/home/images/logo.png `

##### 5 捕获结果
![](res/cap3.png)
其中60.12.8.181就是www.hdu.edu.cn 对应的一个ip，共捕获了308个帧

#### Step 2: Inspect the Trace

#### 中间的一个tcp帧：

![](res/ins1.png)
针对第四个帧进行查看，该帧使用了TCP协议。

#####　协议栈
它对应的协议栈如下：
![](res/ins2.png)
从上到下依次是: 帧, 以太2, IPV4, TCP. 

它们在帧内的顺序也是从前到后的.

不同的协议占的位数不一样.

##### 它的TCP协议的具体字段：

![](res/ins5.png)

可以看到：

源端口：80 一般涉及网页访问的就用80端口号

目标端口：4612 hdu的服务器端口号

序列号：130049 ， 指明当前帧的序列号

ACK号：129

头长度：20 B

flags：![](res/ins4.png)

窗口大小：54

校验和：0x89ce

紧急指针：0

#### Step 3:  TCP Segment Structure 

##### TCP帧中TCP协议每个字段占的字节数：

| 字段名称   | 占的大小（字节） |
| ---------- | ---------------- |
| 源端口号   | 2                |
| 目标端口号 | 2                |
| 序列号     | 4                |
| ack号      | 4                |
| 头长度     | 0.5              |
| Flags      | 1.5              |
| 窗口大小   | 2                |
| 校验和     | 2                |
| 紧急指针   | 2                |

图就不画了. 字段间依次排列.

#### Step 4:  TCP Connection Setup/Teardown 

#### 三次握手

往前找，前两个帧恰好是SYN标志的：

![](res/set1.png)

应用过滤器：

![](res/set2.png)

就只有前两个是syn

先看看每个帧的字段数值吧：

**第一个帧：**

![](res/set3.png)

Seq = 0 , Flag = SYN ， Time = 0.000000

**第二个帧：**

![](res/set4.png)

Seq = 0 , Flag = (SYN，ACK) , ack = 1 ， Time = 0.046407

**第三个帧：**

![](res/set5.png)

Seq = 1 , Flag = (ACK) , ack = 1 ， Time = 0.046505

**第四个帧：**（GET帧）

![](res/set6.png)

Seq = 1 , Flag = (PSH, ACK) , ack = 1 ， Time = 0.047816

**图：**

![](res/set7.png)

#### SYN携带的参数

查看第一个SYN携带的额外参数：

![](res/can1.png)

可以看到有额外的参数：

MSS 最大帧大小: 1460

Window Scale: 8 窗口缩放尺度，以后的我方传递给服务器的窗口大小都必须乘以2^8（256）

SACK permitted：确认可以开启sack功能

没有timesamps(长度为0)

#### FIN/RST Teardown

最后一个帧就是发出去的RST帧。

![](res/set8.png)

我的是RST，不需要对方回复了。

图：

![](res/set9.png)

#### Step 5: TCP Data Transfer

图像：

![](res/set10.png)



感觉这个图片不是很大，我估计是因为下载的东西太少了，还没到那个最大速率的时候，就已经下完了。我重新找了一个大的图片来下载：

地址：http://dangan.hdu.edu.cn/_upload/article/images/5d/2d/ad3347084e55987b4d5873d17428/48beb93c-7b9e-430e-bb74-bd6b68cf1cd7.jpg

wget:

![](res/set11.png)

可以看到该图片大小为6MB左右。 ip: 60.12.8.181

wireshark捕捉：

![](res/a1.png)

捕了5107帧

画图：

![](res/a2.png)

发现途中2s左右断了一下，查看该处附近的包：

![](res/a3.png)

发现出现了一个 spurious retransmission 虚假重传，网上百度一下

![](res/a4.png)

很奇怪。

问题：

1. 大概速度： 看不出来上限，最大值是2600包/秒

   ![](res/a5.png)

   2. 8e7 位/秒

2.   ![](res/a6.png)

   这里的第1659帧，总大小1494，TCP占20，所以占用比率是20/1494 = 1.34%

3. 上传的速率小得多：大概是250包/秒 ， 1e5位/秒

4. x+1

后面截一个 1个上传确认帧 对应多个下载帧的图片：

![](res/a7.png)

可以看到黄色高亮的上传帧之间隔了好几个 下载的帧。

